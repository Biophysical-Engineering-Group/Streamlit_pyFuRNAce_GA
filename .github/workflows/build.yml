name: Weekly patched Streamlit wheel

on:
  schedule:
    # Every Monday at 03:30 UTC
    - cron: "30 3 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install wheel

      - name: Download latest Streamlit wheel (only the package itself)
        run: |
          rm -f *.whl || true
          pip download --no-deps --only-binary=:all: streamlit
          echo "Wheel(s) downloaded:"
          ls -1 streamlit-*.whl

      - name: Unpack just that wheel
        run: |
          WHEEL=$(echo streamlit-*.whl)
          python -m wheel unpack "$WHEEL"

      - name: Remove original wheel
        run: |
          rm -f streamlit-*.whl

      - name: Patch index.html with GA snippet
        run: |
          python scripts/patch_streamlit.py

      - name: Repack
        run: |
          DIR=$(echo streamlit-*)
          python -m wheel pack "$DIR"
          echo "Repacked:"
          ls -1 *.whl

      - name: Make filename predictable (optional)
        run: |
          WHEEL=$(ls -1 *.whl | head -n1)
          BASE="${WHEEL%.whl}"
          mv "$WHEEL" "${BASE}+ga.whl"
          ls -1 *.whl

      - name: Clean repo to only keep the new wheel
        run: |
          shopt -s extglob
          mkdir -p keep_tmp
          # Keep workflow, scripts, and the wheel
          cp -r .github scripts *.whl keep_tmp/
          # Remove everything except .git, .github, scripts, keep_tmp
          rm -rf !(.git|.github|scripts|keep_tmp)
          shopt -u extglob
          mv keep_tmp/* .
          rmdir keep_tmp || true

      - name: Commit & push wheel if changed
        run: |
          set -e
          WHEEL=$(ls -1 *.whl | head -n1)
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Weekly: update ${WHEEL}"
            git push
          fi

      - name: Create/update 'latest' release with asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WHEEL=$(ls -1 *.whl | head -n1)
          TAG="latest"
          # Create 'latest' if missing
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" -t "Latest patched wheel" -n "Automated weekly build."
          # Re-upload asset (delete existing if name collides)
          if gh release view "$TAG" --json assets -q ".assets[].name" | grep -Fx "$WHEEL" >/dev/null 2>&1; then
            gh release delete-asset "$TAG" "$WHEEL" -y
          fi
          gh release upload "$TAG" "$WHEEL" --clobber
